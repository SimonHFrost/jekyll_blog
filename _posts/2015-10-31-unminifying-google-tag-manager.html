---
layout: post
title: Unminifying Google Tag Manager
tag:
- code
---

<p>I recently had to enhance the analytic tracking capabilities at work. We use Google Tag Manager (GTM) along with Google Analytics (GA).</p><p>If you haven’t heard of GTM, it’s essentially a code snippet you include that provides capability to dynamically modify ‘tags’ which include code snippets such as Google Analytics.</p><p>I unminified the GTM snippet due to timing issues related to our implementation that couldn’t be resolved by recommended solutions found online in order to better understand how the script is loaded asynchronously.</p><p>Here is the original GTM snippet provided:</p><pre>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({&#39;gtm.start&#39;: new Date().getTime(),event:&#39;gtm.js&#39;});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!=&#39;dataLayer&#39;?&#39;&amp;l=&#39;+l:&#39;&#39;;j.async=true;j.src= &#39;//www.googletagmanager.com/gtm.js?id=&#39;+i+dl;f.parentNode.insertBefore(j,f); })(window,document,&#39;script&#39;,&#39;dataLayer&#39;,&#39;GTM-XXXXXX&#39;);</pre><p>Using a tool can automatically insert whitespace which greatly helps in readability. I used <a href="http://unminify.com/">http://unminify.com/</a></p><pre>(function(w, d, s, l, i) {<br>  w[l] = w[l] || [];<br>  w[l].push({<br>  ‘gtm.start’: new Date().getTime(),<br>    event: ‘gtm.js’<br>  });<br>  var f = d.getElementsByTagName(s)[0],<br>      j = d.createElement(s),<br>      dl = l != ‘dataLayer’ ? ‘&amp;l=’ + l : ‘’;<br>  j.async = true;<br>  j.src = ‘//<a href="http://www.googletagmanager.com/gtm.js?id=%27">www.googletagmanager.com/gtm.js?id=’</a> + i + dl;<br>  f.parentNode.insertBefore(j, f);<br>})(window, document, ‘script’, ‘dataLayer’, ‘GTM-XXXXXX’);</pre><p>Here we can see a function is defined and immediately executed with a set of values. A function is used to create an scope apart from the global scope, and parameters are used instead of local variables in order to save characters from an extra var.</p><p>Next I renamed the function parameters and internal variables. Luckily in this example the characters are the first letter of the values applied.</p><p>There are other methods of parameter naming such as in the Google Analytics snippet where the letters ‘I S O G R A M’ are used. An isogram can be: ‘a word or phrase in which each letter appears the same number of times’, which is a nice easter egg :)</p><pre>(function(window, document, script, datalayer, id) {<br>        window[datalayer] = window[datalayer] || [];<br>        window[datalayer].push({<br>            &#39;gtm.start&#39;: new Date().getTime(),<br>            event: &#39;gtm.js&#39;<br>        });<br>        var firstScript = document.getElementsByTagName(script)[0];<br>        var gtmScript = document.createElement(script);<br>        var dataLayerParam = datalayer != &#39;dataLayer&#39; ? &#39;&amp;l=&#39; + datalayer : &#39;&#39;;<br>        gtmScript.async = true;<br>        gtmScript.src = &#39;//www.googletagmanager.com/gtm.js?id=&#39; + id + dataLayerParam;<br>        firstScript.parentNode.insertBefore(gtmScript, firstScript);<br>    })(window, document, &#39;script&#39;, &#39;datalayer&#39;, &#39;GTM-XXXXXX&#39;);</pre><p>Above is the final unminified code. In summary:</p><ul><li>A global datalayer array is created for event tracking</li><li>A timestamped datalayer event for ‘GTM initializtion’ is added to the datalayer array</li><li>An async script element with a configurable GTM id and an optional dynamic datalayer name are prepared</li><li>The async script element is finalised and inserted into the DOM before all other scripts on the page</li></ul><p>For a more comprehensive analysis, please view the annotated source at the bottom of the file.</p><p>After I finished I was curious what the referenced script actually does. I decided not to investigate since it was hundreds of lines long, but would guess it’s responsible for modifying and handling events within the datalayer variable created within the snippet.</p><p>I then found an article related to asynchronous script loading here: <a href="https://www.igvita.com/2014/05/20/script-injected-async-scripts-considered-harmful/">https://www.igvita.com/2014/05/20/script-injected-async-scripts-considered-harmful/</a> where I found that not only does the property async = true provide asynchronous loading, but by creating an element and then inserting it into the DOM it also provides async support for older browsers that don’t support the async flag.</p><p>After understanding the snippet and reading the above article, I now felt a lot more confident about asynchronous script loading and managed to fix my issue.</p><p><strong>ANNOTATED SOURCE</strong></p><pre>(function(window, document, script, datalayer, id) {<br>        // Retrieve datalayer array from window scope or create an empty array if it doesn&#39;t exist<br>        window[datalayer] = window[datalayer] || [];<br><br>        // Push a timestamped event for GTM initialisation<br>        window[datalayer].push({<br>            &#39;gtm.start&#39;: new Date().getTime(),<br>            event: &#39;gtm.js&#39;<br>        });<br><br>        // Get the first script included on the page<br>        var firstScript = document.getElementsByTagName(script)[0];<br><br>        // Create a script element <br>        var gtmScript = document.createElement(script);<br><br>        // Optionally prepare the query parameter string for the datalayer name<br>        var dataLayerParam = datalayer != &#39;dataLayer&#39; ? &#39;&amp;l=&#39; + datalayer : &#39;&#39;;<br><br>        // Enable asynchronous loading for the GTM script<br>        gtmScript.async = true;<br><br>        // Finalise link to GTM script<br>        gtmScript.src = &#39;//www.googletagmanager.com/gtm.js?id=&#39; + id + dataLayerParam;<br><br>        // Insert new script element into DOM<br>        firstScript.parentNode.insertBefore(gtmScript, firstScript);<br><br>    })(window, document, &#39;script&#39;, &#39;datalayer&#39;, &#39;GTM-XXXXXX&#39;);</pre><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=3d1d23e8e666" width="1" height="1" alt="">
